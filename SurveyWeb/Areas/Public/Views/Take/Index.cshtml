@model SurveyWeb.Models.Survey
@{
    Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = $"Thực hiện khảo sát - {Model.Title}";
    var now = DateTime.UtcNow;

    bool IsActive(SurveyWeb.Models.Survey survey)
    {
        if (!string.Equals(survey.StatusCode, "active", StringComparison.OrdinalIgnoreCase))
            return false;
        if (survey.StartAt.HasValue && survey.StartAt.Value > now) return false;
        if (survey.EndAt.HasValue && survey.EndAt.Value < now) return false;
        return true;
    }

    var isAvailable = IsActive(Model);
}

<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-8 col-lg-9">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <h1 class="h4 fw-bold mb-0">@Model.Title</h1>
                            <span class="badge bg-@(isAvailable ? "success" : "secondary")">
                                @(isAvailable ? "Đang mở" : "Không khả dụng")
                            </span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(Model.Description))
                        {
                            <p class="text-muted mb-3">@Model.Description</p>
                        }
                        <ul class="list-inline text-muted small mb-0">
                            <li class="list-inline-item">
                                <i class="bi bi-bookmark-star me-1 text-primary"></i>@Model.Topic?.Name
                            </li>
                            <li class="list-inline-item">
                                <i class="bi bi-calendar-event me-1 text-primary"></i>Bắt đầu: @(Model.StartAt?.ToLocalTime().ToString("dd/MM/yyyy") ?? "Không giới hạn")
                            </li>
                            <li class="list-inline-item">
                                <i class="bi bi-calendar-x me-1 text-primary"></i>Kết thúc: @(Model.EndAt?.ToLocalTime().ToString("dd/MM/yyyy") ?? "Không giới hạn")
                            </li>
                        </ul>
                    </div>
                </div>

                @if (!isAvailable)
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Khảo sát này hiện không khả dụng.
                    </div>
                }
                else
                {
                    <form method="post" class="vstack gap-4">
                        @Html.AntiForgeryToken()

                        @foreach (var question in Model.Questions.OrderBy(q => q.OrderIndex))
                        {
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="small text-muted mb-1">Câu @question.OrderIndex</div>
                                            <div class="fw-semibold">@question.QuestionText</div>
                                        </div>
                                        <span class="badge bg-light text-secondary">
                                            @question.QuestionType
                                        </span>
                                    </div>

                                    <div class="mt-3">
                                        @{
                                            var inputName = $"q_{question.QuestionId}";
                                            var orderedChoices = question.Choices.OrderBy(c => c.OrderIndex).ToList();
                                        }
                                        @switch (question.QuestionType?.ToLowerInvariant())
                                        {
                                            case "single":
                                                if (orderedChoices.Count == 0)
                                                {
                                                    <input type="text" name="@inputName" class="form-control" placeholder="Nhập câu trả lời..." />
                                                }
                                                else
                                                {
                                                    foreach (var choice in orderedChoices)
                                                    {
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" id="choice_@choice.ChoiceId" name="@inputName" value="@choice.ChoiceId" />
                                                            <label class="form-check-label" for="choice_@choice.ChoiceId">@choice.ChoiceText</label>
                                                        </div>
                                                    }
                                                }
                                                break;
                                            case "multi":
                                                if (orderedChoices.Count == 0)
                                                {
                                                    <input type="text" name="@inputName" class="form-control" placeholder="Nhập câu trả lời..." />
                                                }
                                                else
                                                {
                                                    foreach (var choice in orderedChoices)
                                                    {
                                                        var checkboxName = $"q_{question.QuestionId}_opt_{choice.ChoiceId}";
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="choice_@choice.ChoiceId" name="@checkboxName" value="true" />
                                                            <label class="form-check-label" for="choice_@choice.ChoiceId">@choice.ChoiceText</label>
                                                        </div>
                                                    }
                                                }
                                                break;
                                            case "rating":
                                            case "nps":
                                                var min = question.MinValue ?? (question.QuestionType == "nps" ? 0 : 1);
                                                var max = question.MaxValue ?? (question.QuestionType == "nps" ? 10 : 5);
                                                <label class="form-label d-flex justify-content-between">
                                                    <span>Chọn mức từ @min đến @max</span>
                                                </label>
                                                <input type="number" class="form-control" name="@inputName" min="@min" max="@max" step="1" />
                                                break;
                                            default:
                                                <textarea name="@inputName" class="form-control" rows="4" placeholder="Nhập câu trả lời..."></textarea>
                                                break;
                                        }
                                    </div>

                                    @if (question.IsRequired)
                                    {
                                        <div class="small text-danger mt-2">
                                            * Câu hỏi bắt buộc
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="d-flex justify-content-between align-items-center">
                            <a asp-area="Public" asp-controller="Surveys" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Quay lại
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-send-plus me-1"></i>Nộp khảo sát
                            </button>
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>
</section>
